<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ roster_name }} - Warhammer Roster</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>

    <script>
        const onIdClick = (id) => {
            const targetDiv = document.getElementById(id);
            const yOffset = -10;

            if (targetDiv) {
                const newY = targetDiv.getBoundingClientRect().top + window.scrollY + yOffset;
                window.scrollTo({top: newY, behavior: 'smooth'});

                // TODO: Add color highlighting effect
            }
        }
    </script>


    <header>
        <div class="textline-wrap">
            <h1 class="header-text">{{ roster_name }} - </h1>
            {% if cost_value <= cost_limit %}
                <h1 class="header-text"> {{ cost_value }}/{{ cost_limit }} {{ cost_string }}</h1>
            {% else %}
                <h1 class="header-text error-color"> {{ cost_value }}/{{ cost_limit }} {{ cost_string }}</h1>
            {% endif %}
        </div>
        <h3 class="medium-text">Roster generated by <a href="{{ newrecruit_link }}">{{ newrecruit_link }}</a></h3>
    </header>

    <main>

        <div class="army-info-div">
            <h1 class="faction-name">{{ faction_name }}</h1>

            <div class="army-rule-div">
                <pre class="medium-text"><span class="primary-color"><strong>{{ faction_rule_name }}</strong></span>: {{ faction_rule_description }}</pre>
            </div>

            <div class="army-rule-div">
                <pre class="medium-text"><span class="primary-color"><strong>{{ detachment_name }}</strong></span>: {{ detachment_description }}</pre>
            </div>
        </div>

        <h1 class="large-text top-margin">Selected units:</h1>

        <table class="selections-table">
            <tr>
                <th>Name</th>
                <th>Class</th>
                <th>Points</th>
            </tr>

            {% for unit in units %}
                <tr onclick="onIdClick('{{ unit['id'] }}')">
                    <td>{{ unit["name"] }}</td>
                    <td>{{ unit["categories"][0]["name"] }}</td>
                    <td>{{ unit["costs"][0]["value"] }}</td>
                </tr>
            {% endfor %}
        </table>

        <div class="units-div">

            {% for unit in units %}
                <div class="unit-wrapper" id="{{ unit['id'] }}">

                    <div class="unit-title-div">
                        <div class="unit-header-wrapper">
                            <h1 class="medium-text light-color">{{ unit["costs"][0]["value"] }}</h1>
                            <h1 class="medium-text light-color">{{ unit["name"] }}</h1>
                            <h1><!-- Fictional --></h1>
                        </div>
                    </div>

                    <div class="unit-main">

                        <table>
                            <tr>
                                <th>Models</th>
                                <th>Options</th>
                            </tr>
                            
                            {% if unit['type'] == 'model' %}

                                <tr>
                                    <td>{{ unit['name'] }}</td>
                                    <td>
                                        {% for selection in unit['selections'] %}
                                            {{ selection['number'] }} x {{ selection['name'] }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </td>
                                </tr>

                            {% elif unit['type'] == 'unit' %}

                                {% for selection in unit['selections'] %}

                                    <tr>
                                        <td>{{ selection['number'] }} {{ selection['name'] }}</td>
                                        <td>
                                            {% for selec in selection['selections'] %}
                                                {{ selec['number'] }} x {{ selec['name'] }}{% if not loop.last %}, {% endif %}
                                            {% endfor %}
                                        </td>
                                    </tr>

                                {% endfor %}

                            {% endif %}

                        </table>

                        <table>
                            <tr>
                                <th>Unit</th>
                                <th>M</th>
                                <th>T</th>
                                <th>SV</th>
                                <th>W</th>
                                <th>LD</th>
                                <th>OC</th>
                            </tr>

                            <!-- Treat one-model units and non-one-model units differently -->
                            {% if unit['type'] == 'model' %}
                                <tr>
                                    <td>{{ unit['name'] }}</td>

                                    {% for char in unit['profiles'][0]['characteristics'] %}
                                        <td>{{ char['$text'] }}</td>
                                    {% endfor %}
                                </tr>
                            {% elif unit['type'] == 'unit' %}
                                {% for selection in unit['selections'] %}
                                    <tr>
                                        <td>{{ selection['name'] }}</td>
                                        {% for char in selection['profiles'][0]['characteristics'] %}
                                            <td>{{ char['$text'] }}</td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            {% endif %}
                        </table>

                        <table>
                            <tr>
                                <th>Ranged Weapons</th>
                                <th>Range</th>
                                <th>A</th>
                                <th>BS</th>
                                <th>S</th>
                                <th>AP</th>
                                <th>D</th>
                                <th>Keywords</th>
                            </tr>

                            {% for weapon in unit['ranged_choices'] %}
                            <tr>
                                {% for profile in weapon['profiles'] %}
                                    {% if weapon['number'] > 1 %}
                                        <td>{{ weapon['number'] }} x {{ profile['name'] }}</td>
                                    {% else %}
                                        <td>{{ profile['name'] }}</td>
                                    {% endif %}

                                    {% for char in profile['characteristics'] %}
                                        <td>{{ char['$text'] }}</td>
                                    {% endfor %}
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </table>

                        <table>
                            <tr>
                                <th>Melee Weapons</th>
                                <th>Range</th>
                                <th>A</th>
                                <th>WS</th>
                                <th>S</th>
                                <th>AP</th>
                                <th>D</th>
                                <th>Keywords</th>
                            </tr>

                            {% for weapon in unit['melee_choices'] %}
                                {% for profile in weapon['profiles'] %}
                                <tr>
                                    {% if weapon['number'] > 1 %}
                                        <td>{{ weapon['number'] }} x {{ profile['name'] }}</td>
                                    {% else %}
                                        <td>{{ profile['name'] }}</td>
                                    {% endif %}

                                    {% for char in profile['characteristics'] %}
                                        <td>{{ char['$text'] }}</td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            {% endfor %}
                        </table>
                    </div>
                </div>
            {% endfor %}

        </div>

    </main>

    <footer>
        {% for rule in rules.items() %}
            <details id="{{ rule[0] }}" class="rule-div">
                 <summary class="header-text">{{ rule[1][0] }}</summary>

                 <h1 class="medium-text">{{ rule[1][1] }}</h1>
            </details>
        {% endfor %}
    </footer>
</body>
</html>
